<!DOCTYPE html>
<html>
<head>
<title>synctool documentation</title>
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="stylesheet" type="text/css" href="synctool_doc.css" />
</head>
<body>

<div id="page">

<div id="header">

<h1>synctool documentation</h1>
<br class="vtab" />
<p>
<em>synctool &copy; 2024 Walter de Jong &lt;walter@heiho.net&gt;</em>
<br />
<br />
synctool comes with <strong>no warranty</strong>. synctool is
<strong>free software</strong>.<br />
synctool is distributed under terms described
in the <a href="http://www.gnu.org/licenses/gpl-2.0.html">GNU General Public
License</a>.
</p>

</div>   <!-- end header -->

<div id="content">
<h2>Table of contents</h2>

<ol>
<li><p><a href="chapter1.html">What is synctool</a></p></li>
<li><p><a href="chapter2.html">Installation</a>                         <br />
2.1 Installation dependencies                          <br />
2.2 Passwordless SSH                                   <br />
2.3 Installing the software                            <br />
2.4 synctool configuration: nodes and groups           <br />
2.5 Testing with dsh                                   <br />
2.6 Your first synctool run                            <br />
2.7 Client installation</p></li>
<li><p><a href="chapter3.html">Using synctool</a>                       <br />
3.1 Populating the repository                          <br />
3.2 Adding actions to updates                          <br />
3.3 Other useful options                               <br />
3.4 Templates                                          <br />
3.5 Purge directories                                  <br />
3.6 The order of operations                            <br />
3.7 dsh-pkg, the synctool package manager              <br />
3.8 Ignoring them: I&#8217;m not touching you                <br />
3.9 Backup copies                                      <br />
3.10 Logging                                           <br />
3.11 About symbolic links                              <br />
3.12 Slow updates                                      <br />
3.13 Checking for updates                              <br />
3.14 Running tasks with synctool                       <br />
3.15 Multiplexed connections</p></li>
<li><p><a href="chapter4.html">All configuration parameters explained</a></p></li>
<li><p><a href="chapter5.html">Best practices</a>                       <br />
5.1 Use logical group names                            <br />
5.2 Future planning: Be mindful of group &#8216;all&#8217;         <br />
5.3 Use group extensions on directories sparingly      <br />
5.4 Do not manage the master node                      <br />
5.5 Managing multiple clusters with one synctool       <br />
5.6 Use a tiered setup for large clusters              <br />
5.7 Manage hosts behind a gateway</p></li>
<li><p><a href="thank_you.html">Thank you</a>                           <br /></p></li>
</ol>
<br /><br /><div class="line"> </div><br /> 
<h1>1. What is synctool</h1>

<p>synctool is a tool that can help you administer your cluster of computers.
Its primary function is keeping configuration files &#8216;in sync&#8217;,
i.e.: as they ought to be. Its core business is copying configuration files
to groups (or classes) of computers within a cluster and comparing such
files with a normative copy that you keep in a repository.
The repository, by the way, is not some database system, but an &#8216;overlay&#8217;
directory tree in a file system, that looks very much like the directories
of the managed target systems. The only things missing from the repository
are the files and directories that you do not <em>want</em> or need synctool to
manage. In the repository, you can manage directories with conventional
UNIX tools &#8212; <code>cp</code>, <code>mv</code>, <code>mkdir</code> &#8212; or any tool you like, and you can edit
files with the editor of preference.</p>

<p>There are other tools in existence that do the same thing as synctool,
and ironically, none of them are as easy to understand and use as synctool.
Perhaps this is so, because other tools try to do the same thing, among
many other things as well. synctool does <em>not</em> try to be an all
encompassing system administation tool, and does not have its own little
scripting language to define your system in. It does not strive to automate
all aspects of the system administrator&#8217;s work. Rather, it focuses on its
core business only and concentrates on doing that very well.
This is very much in line with the traditional UNIX design philosophy &#8212;
and with common sense. The powerful set of now common shell tools grew by
adding commands that were designed to do only specific tasks very well and
to be used easily in combination with other tools that specialize in other
tasks.</p>

<p>Because of that design philosophy:</p>

<ul>
<li><p>synctool integrates very easily into existing system adminstration
practices as an add-on tool, specifically to do configuration file
management. It does not interfere with other things and does not need
much either: It is written in the Python language, and it uses the power
of <code>rsync</code> and <code>ssh</code> to distribute files.</p></li>
<li><p>It is possible to use synctool in the style that suits you best: Warn you
whenever things are out of &#8216;sync&#8217; or do automated repairs of deviations.
It is even possible to manage some files with synctool and leave other
files to other mechanisms &#8212; what is not represented in the synctool
repository is not managed by it.</p></li>
<li><p>Although synctool has many command-line options, its set of core functions
is very small and easy to understand. There is not that much you need to
know to use it, so there is virtually no learning curve to get you started
with synctool.</p></li>
</ul>

<p>In addition, synctool simplifies things by working with the following
concepts:</p>

<ul>
<li>Some clusters are more homogeneous than others. To handle differentiation
within a cluster, a host can be part of one or more logical groups;</li>
<li>Files are designated to a group by means of filename extension;</li>
<li>The &#8216;overlay&#8217; directory tree contains the files that are &#8216;synced&#8217; to the
target hosts;</li>
<li>When certain files are updated, you will want to execute a script
(e.g, to run <code>'service daemon restart'</code>).
synctool has a mechanism for this. You can make synctool more powerful
by writing plugin scripts that run the commands you want whenever
a particular file has been updated.</li>
</ul>

<p>synctool manages configuration files, not processes, and not full system
installations. However, synctool comes with handy tools to run commands
across the cluster and do synchronized updates of software packages.</p>

<p>synctool does not hide UNIX from you.
Making clever use of synctool makes it a very powerful tool.</p>

<p>synctool started in 2003 and has since been in use with great success, doing
real work at big computing sites. Hopefully, it will be of some value to you
as well.</p>
<br /><br /><div class="line"> </div><br /> 
<h1>2. Installation</h1>

<blockquote>
  <p>In synctool terminology, a <em>node</em> is a host, a computer in a group
of computers. A group of computers is called a <em>cluster</em>.</p>
</blockquote>

<h2>2.1 Installation dependencies</h2>

<p>synctool depends on a number of (fairly standard) programs:</p>

<ul>
<li><a href="https://www.python.org/download/">python3</a> version 3.6 or better</li>
<li><a href="https://www.openssh.com/portable.html">ssh</a>, preferably OpenSSH version 5.6 or better</li>
<li><a href="https://rsync.samba.org/">rsync</a></li>
<li><code>ping</code>, or you can configure <a href="https://fping.org/">fping</a> later</li>
<li><a href="https://daringfireball.net/projects/markdown/">markdown</a> and <a href="https://daringfireball.net/projects/smartypants/">smartypants</a> &#8212; but only if you want to install
this documentation as HTML pages</li>
</ul>

<p>If you got all that, it&#8217;s on to the next section.</p>

<h2>2.2 Passwordless SSH</h2>

<p>synctool requires passwordless SSH from the master node to each cluster node
as root. If you need more information on how to set this up, please see the
SSH documentation or just google around. I like to give you these tips:</p>

<ul>
<li>use an SSH keypair</li>
<li>or use hostbased authentication, also for root</li>
<li>set <code>PermitRootLogin without-password</code> in <code>sshd_config</code> on the nodes</li>
<li>use <code>ssh-keyscan</code> to create <code>/etc/ssh/ssh_known_hosts</code></li>
<li>run <code>sshd</code> only the internal network interface to secure your system;
configure <code>ListenAddress</code> appropriately</li>
<li>in general, passwordless SSH from any cluster node to your master node
should <em>not</em> work or be allowed &#8212; or at least, synctool does not need this</li>
</ul>

<p>If you want extra security, use a passphrase on the keypair and employ
<code>ssh-agent</code>. Use <code>ssh-add</code> with a timeout.
For sites with extra tight security, it is possible to configure <code>ssh</code> to
run only specific (synctool) commands, or maybe you want to change
the <code>ssh_cmd</code> in synctool&#8217;s configuration so that it runs a different command,
one that does suit your security needs.</p>

<p>When passwordless SSH as root works, proceed to installing the software.</p>

<h2>2.3 Installing the software</h2>

<p>To install synctool on the master node, run <code>setup.sh</code> like so:</p>

<pre><code># ./setup.sh --installdir=/opt/synctool
</code></pre>

<p>The default location is <code>/opt/synctool</code>, which is a good place to put it.
Note that synctool requires an &#8216;installdir&#8217; directory of its own. The
installdir is not the same as a prefix; whatever you do, do <em>not</em> install
synctool directly under <code>/usr</code> or <code>/usr/local</code>. Use <code>/usr/synctool</code> or
<code>/usr/local/synctool</code> instead, or better, stick with the default location.
The rest of the documentation assumes the default <code>/opt/synctool</code>.</p>

<p><code>setup.sh</code> creates the following directory structure:</p>

<pre><code>/opt/synctool/bin/                  synctool commands
/opt/synctool/sbin/                 'system' programs
/opt/synctool/etc/                  configuration files
/opt/synctool/lib/                  libraries, modules
/opt/synctool/lib/synctool/
/opt/synctool/lib/synctool/main/
/opt/synctool/lib/synctool/pkg/
/opt/synctool/doc/                  documentation
/opt/synctool/scripts/              place to store your scripts
/opt/synctool/var/                  repository directory
/opt/synctool/var/overlay/
/opt/synctool/var/delete/
/opt/synctool/var/purge/
</code></pre>

<p>The <code>doc/</code> directory contains a copy of this documentation.
You may build the HTML documentation from the plain text sources
by running <code>setup.sh</code> with <code>--build-docs</code>.</p>

<p>The following synctool commands will be made available in
<code>/opt/synctool/bin/</code>:</p>

<pre><code>synctool               Main command
dsh                    Run remote commands
dsh-pkg                Upgrade or install packages
dsh-ping               Check whether nodes are up
dsh-cp                 Copy files to nodes

synctool-client        Only run on target nodes
synctool-client-pkg    Only run on target nodes
synctool-config        Inspect the configuration
synctool-template      Useful command for .post scripts
</code></pre>

<blockquote>
  <p>Tip: Add <code>/opt/synctool/bin</code> to your <code>PATH</code>.</p>
</blockquote>

<h2>2.4 synctool configuration: nodes and groups</h2>

<p>Copy the <code>synctool.conf.example</code> file to <code>/opt/synctool/etc/synctool.conf</code>.
Edit <code>synctool.conf</code>, adjusting it as needed.</p>

<p>The file <code>synctool.conf</code> describes what your cluster looks like;
what nodes have what roles, and how synctool can contact them.
Think a bit about what role each machine has. There is no need to go into
great depth right now; you can always adjust the configuration later.</p>

<pre><code>node n1  group1 group2  ipaddress:machine-n01
</code></pre>

<p>The nodename is the &#8216;synctool name that the node has.&#8217; It is in general the
short hostname of the host, but in fact it can be anything you like.
The nodename has nothing to do with hostnames or DNS entries.
The <code>ipaddress</code> specifier tells synctool how to contact the node; this can be
an IP address or a DNS name of the host you wish to contact. In clusters,
there is often a management network interface &#8212; configure its IP address
here. The <code>ipaddress</code> specifier is <em>optional</em> and only needed if the nodename
does not exactly match the DNS name for contacting the remote host.</p>

<p>Directly following the node name, you can list groups. synctool uses the
term &#8216;group&#8217;, but you can also think of them as node properties. You can make
up as many different properties as you like. You can split long lines by
ending them with a backslash:</p>

<pre><code>node n101 workernode plasma mathworks solar \
      fsmounted backup debian  ipaddress:if0-n101
</code></pre>

<blockquote>
  <p>Mind that in practice, synctool repositories are generally easiest
maintainable with as few groups as possible. Make sure to use
logical names for logical groups, and use a top-down group structure.
Make things easy on yourself.</p>
</blockquote>

<p>If you have many nodes that all share the same long list of groups, the
groups may be abbreviated by defining a <em>compound</em> group. This compound
group must be defined before defining the nodes:</p>

<pre><code>group wn workernode plasma mathworks solar \
     fsmounted backup

node n101  wn  debian  ipaddress:if0-n101
</code></pre>

<p>You have to add a node definition for each and every node in your cluster.
If your nodes are neatly numbered (and for large clusters, they often are),
you can make use of node ranges and IP address sequences, like so:</p>

<pre><code>node n[001-100]  wn  debian  ipaddress:if0-n[001]
node n[101-200]  wn  debian  ipaddress:192.168.1.[20]
</code></pre>

<p>If you do have the luxury of a high performance shared filesystem on your
cluster, you may put <code>/opt/synctool/</code> on there and add <code>rsync:no</code> to the node
definition lines in the config file to tell synctool not to run <code>rsync</code>.
Mind that there are certain security implications with having a shared
filesystem between management and production nodes.</p>

<p>Next, you have to tell synctool which node is the master management node.
This is done by setting <code>master</code> to the fqdn (fully qualified domain name)
of the management host.</p>

<pre><code>master n1.mycluster.org
</code></pre>

<p>If you don&#8217;t know what the fqdn is, you can get it by running the command:</p>

<pre><code>synctool-config --fqdn
</code></pre>

<p>If you want to manage the master node itself with synctool, you should also
define it as a node. It is a matter of taste, but it is maybe better <em>not</em>
to do so. If you choose not to manage the master node, it may be omitted
from the configuration. You may also explicitly exclude it:</p>

<pre><code>node n1 master           hostname:n1.mycluster.org
ignore_node n1
</code></pre>

<p>Beside a master node, you may also define slave nodes.
Slaves are cold standby&#8217;s that get full copies of the synctool repository.
A slave may be used as a failback in case your management host breaks down.
Since there can be only one master node in a synctool cluster, slaves must
be enabled &#8216;by hand&#8217; by editing the config file and changing the master
definition.</p>

<blockquote>
  <p>Previous versions of synctool had a <code>masterdir</code> setting.
It no longer exists; the overlay directory now must reside under
the synctool root, under <code>/opt/synctool/var/</code>.</p>
</blockquote>

<p>You can test your <code>synctool.conf</code> with the command <code>synctool-config</code>.
It&#8217;s more exciting however to test with <code>dsh</code> and actually run commands
on the cluster.</p>

<h2>2.5 Testing with dsh</h2>

<p>After filling in a couple of nodes in <code>synctool.conf</code>, try the command
<code>dsh-ping</code> to see if the nodes are &#8216;up&#8217;. If they are, try running the
commands <code>dsh hostname</code>, <code>dsh uptime</code>, or <code>dsh date</code>.
If you correctly set up passwordless SSH, <code>dsh</code> should run the commands on
every node without problems or needed manual intervention. It is important
that this works before proceeding.</p>

<blockquote>
  <p>Some (mostly IBM) systems already have a <code>dsh</code> command.
Be mindful to start the correct <code>dsh</code> command.</p>
</blockquote>

<p>See section 3.15 for a trick that greatly speeds up synctool and dsh using
OpenSSH&#8217;s multiplexed connections capability.</p>

<h2>2.6 Your first synctool run</h2>

<p>Now that you have a rough setup on the master node, try running <code>synctool</code>
to a single node:</p>

<pre><code>synctool -n nodename
</code></pre>

<p>There should be some output message saying <strong>DRY RUN</strong>.
This means that synctool is now working. You can try running synctool across
all nodes:</p>

<pre><code>synctool
</code></pre>

<p>Check that every node responds. If it doesn&#8217;t, go back to the step where
we tested the setup using <code>dsh</code>.
When synctool to every node works, the basic setup is done and you can start
filling your repository with useful files.</p>

<h2>2.7 Client installation</h2>

<p>As you may have noticed, we never installed any client software on the nodes.
There is no client installation step; the master node automatically
updates synctool on the client nodes. The binaries needed for this are
located under <code>/opt/synctool/sbin/</code>, and this directory gets synced to the
nodes with <code>rsync</code> every time you run <code>synctool</code>.</p>
<br /><br /><div class="line"> </div><br /> 
<h1>3. Using synctool</h1>

<p>The main power of synctool is the fact that you can define logical groups,
and you can add these to a filename as a filename extension. This will result
in the file being copied, only if the node belongs to the same group.
The groups a node is in, are defined in the <code>synctool.conf</code> file.
In the configuration file, the nodename is associated with one or more groups.
The nodename itself can also be used as a group to indicate that a file
belongs to that node.</p>

<p>Under the synctool root there are these interesting directories:</p>

<ul>
<li><code>/opt/synctool/var/overlay/</code></li>
<li><code>/opt/synctool/var/delete/</code></li>
<li><code>/opt/synctool/var/purge/</code></li>
</ul>

<p>This is referred to as &#8216;the repository&#8217;.</p>

<p>The <code>overlay/</code> tree contains files that have to be copied to the target nodes.
When synctool detects a difference between a file on the system and a file
in the overlay tree, the file will be copied from the overlay tree onto
the node.</p>

<p>The <code>delete/</code> tree contains files that always have to be deleted from the
nodes. Only the filename matters, so it is alright if the files in this tree
are only zero bytes in size.</p>

<p>The <code>purge/</code> tree contains directories that are copied as-is to the nodes,
and deleting any files on the target node that are unmanaged &#8212; files that
should not be there.</p>

<p>synctool uses <code>rsync</code> to copy these trees to the node, and afterwards it
runs the <code>synctool-client</code> command on that node. Note that it is perfectly
possible to run <code>synctool-client</code> on a node by hand, in which case it will
check its local copy of the repository. The client by itself will not
synchronize with the master repository; synctool works with <em>server push</em>
and not client pull.</p>

<blockquote>
  <p>In old times, synctool was located under <code>/var/lib/synctool/</code>.
It worked for me (tm), except that the Filesystem Hierarchy Standard (FHS)
has various things to say about it:</p>

<ul>
<li>thou shalt put configuration files under an <code>etc/</code> directory;</li>
<li>thou shalt not execute programs from the <code>/var</code> partition;</li>
<li><code>/var</code> may be mounted read-only;</li>
<li>programs that want to keep things together, should use <code>/opt</code>.</li>
</ul>

<p>If you have difficulty with getting used to synctool&#8217;s new root,
try this:</p>

<ul>
<li>symlink <code>/var/lib/synctool -&gt; /opt/synctool/var</code></li>
<li><code>export overlay=/opt/synctool/var/overlay ; cd $overlay</code></li>
</ul>
</blockquote>

<h2>3.1 Populating the repository</h2>

<p>In the repository you will store all the important system configuration files
of the cluster nodes. The overlay directory represents the root directory of
the cluster nodes. By assigning an extension to a file in the repository,
you can tell synctool what nodes should get what copy of a file.
Consider this example:</p>

<pre><code>/opt/synctool/var/overlay/all/
  etc/ntp.conf._all
  etc/ntp.conf._node1
  etc/ntp.conf._wn
</code></pre>

<p>Here, worker nodes (nodes tagged with group <code>wn</code> in <code>synctool.conf</code>) will
get the file <code>ntp.conf._wn</code> for <code>/etc/ntp.conf</code>. Node <code>node1</code> is special
and gets a different file. All other nodes will get <code>ntp.conf._all</code>.</p>

<p>There is a special group named <code>'none'</code>. Files with the extension <code>._none</code>
will be copied to no nodes at all. This can be convenient when you
temporarily wish to &#8216;disable&#8217; a file.</p>

<p>synctool responds to the directory directly under <code>overlay/</code>; it selects
this subtree as a candidate when the node has a matching group. For example,</p>

<pre><code>/opt/synctool/var/overlay/wn/
  etc/ntp.conf._all
</code></pre>

<p>this file will only be used on worker nodes because it resides in the
overlay directory specific to the group <code>wn</code>.</p>

<blockquote>
  <p>Tip: Do not make group-specific overlay directories for each and every
group. Instead, think about what subclusters you have, and arrange your
repository accordingly. See also chapter 5 on Best Practices.</p>

<p>In synctool version 5, you would configure &#8216;overlaydir&#8217; and synctool would
still consider all overlay directories no matter what name the subdirectory
had. In synctool 6 and up, the group is strictly enforced and the subtree
is synced to only those nodes that are in the group.
Slave nodes are special; they get a full copy of the repository.</p>
</blockquote>

<p>To populate the repository, you can <code>scp</code> files from nodes, or you can use
synctool&#8217;s super convenient upload feature:</p>

<pre><code>synctool -n node1 --upload /etc/ntp.conf
synctool -n node1 -u /etc/ntp.conf
</code></pre>

<p>synctool will automatically choose an extension for the file to save. If you
disagree and want a different suffix, choose one:</p>

<pre><code>synctool -n node1 --upload /etc/ntp.conf --suffix wn
synctool -n node1 -u /etc/ntp.conf -s wn
</code></pre>

<p>synctool will suggest the overlay directory where to put the file in
the repository. If you disagree, use:</p>

<pre><code>synctool -n node1 --upload /etc/ntp.conf --overlay mycluster
synctool -n node1 -u /etc/ntp.conf -o mycluster
</code></pre>

<p>By default synctool does a <em>dry run</em>. It will not do anything but show
what would happen if this would not be a dry run. Add <code>-f</code> or <code>--fix</code> to
really upload the file.</p>

<p>Now edit the the uploaded <code>ntp.conf</code>, make some changes and run synctool:</p>

<pre><code>root@masternode:/# synctool
node1: DRY RUN, not doing any updates
node1: /etc/ntp.conf updated (file size mismatch)
</code></pre>

<p>Again, synctool does a <em>dry run</em>. It shows the file is going to be updated
because there is a mismatch in the file size. Should the file size be the
same, synctool will calculate an MD5 checksum to see whether the file was
changed or not.</p>

<p>You may want to review your changes before applying them, or inspect the
difference between the version in the repository with what&#8217;s currently
installed on a node:</p>

<pre><code>synctool -n node1 --diff /etc/ntp.conf
synctool -n node1 -d /etc/ntp.conf
</code></pre>

<p>This will present a UNIX &#8216;diff&#8217; of the files. Note the destination path in
the syntax of the command.</p>

<p>To apply the change, you could now run synctool with option <code>--fix</code>.
But maybe it&#8217;s better to read on, we are going to have synctool automatically
reload the <code>ntpd</code> after updating the <code>ntp.conf</code> file.</p>

<h2>3.2 Adding actions to updates</h2>

<p>Now I would like the <code>ntpd</code> to be automatically reloaded after I change
the <code>ntp.conf</code> file. This is done by adding a trigger script, in
synctool-speak known as a &#8220;.post&#8221; script.</p>

<p>Make a new file <code>overlay/all/etc/ntp.conf.post</code> and put only this line in it:</p>

<pre><code>service ntp reload
</code></pre>

<p>Make the <code>.post</code> script executable: <code>chmod +x ntp.conf.post</code>.</p>

<p>The <code>.post</code> script will be run when the file changes:</p>

<pre><code>root@masternode:/# synctool -f
node1: /etc/ntp.conf updated (file size mismatch)
node1: running command $overlay/all/etc/ntp.conf.post
</code></pre>

<p>The <code>.post</code> script is run after synctool updated the file, and likewise,
you may also create a <code>.pre</code> script that runs before the update:</p>

<pre><code>root@masternode:/# synctool -f
node1: running command $overlay/all/etc/ntp.conf.pre
node1: /etc/ntp.conf updated (file size mismatch)
node1: running command $overlay/all/etc/ntp.conf.post
</code></pre>

<p>The <code>.pre</code> and <code>.post</code> scripts are executed in the directory where the
accompanying file resides; in this case <code>/etc/</code>. It is possible to add
a group extension to the script, so that you can have one group of nodes
perform different actions than another.</p>

<p>The scripts are run with <code>sh -c</code>. Note that <code>/bin/sh</code> is often not the
same as <code>bash</code>, so some clever shell scripting tricks may not work. However,
you can fix this by including &#8220;<code>#!/bin/bash</code>&#8221; in the top of the <code>.post</code>
script.</p>

<p>In the environment you will find two variables that might be useful:</p>

<ul>
<li><code>SYNCTOOL_NODE</code> is set to the node that we&#8217;re running on</li>
<li><code>SYNCTOOL_ROOT</code> is set to the directory where synctool lives</li>
</ul>

<p>So expanding on that, <code>$SYNCTOOL_ROOT/bin/</code> is the bindir, and the repository
is found under <code>$SYNCTOOL_ROOT/var/overlay/</code>.</p>

<p>A <code>.post</code> script for a directory will trigger when any file in that directory
changes. This is particularly useful for daemons that have multiple config
files in a directory, such as <code>conf.d</code>, or, for example, <code>/etc/cron.d</code>.
A <code>.pre</code> script for a directory will only trigger if the directory does not
exist and will be created.</p>

<h2>3.3 Other useful options</h2>

<p>The option <code>-q</code> of synctool gives less output:</p>

<pre><code>root@masternode:/# synctool -q
node3: /etc/xinetd.d/identd updated (file size mismatch)
</code></pre>

<p>If <code>-q</code> still gives too much output, because you have many nodes in your
cluster, it is possible to specify <code>-a</code> to condense (aggregate) output.
The condensed output groups together output that is the same for many nodes.</p>

<p>One of my favorite commands is <code>synctool -qa</code>.
You may also use option <code>-a</code> to condense output from <code>dsh</code>, for example</p>

<pre><code># dsh -a date

# dsh-ping -a
</code></pre>

<p>The option <code>-f</code> or <code>--fix</code> applies all changes. Always be sure to run
synctool at least once as a dry run! (without <code>-f</code>).
Mind that synctool does not lock the repository and does not guard against
concurrent use by multiple sysadmins at once. In practice, this hardly ever
leads to any problems.</p>

<p>To update only a single file rather than all files, use the option
<code>--single</code> or <code>-1</code> (that&#8217;s a number one, not the letter <em>ell</em>).
You may give multiple <code>--single</code> options to update multiple files at once.</p>

<p>If you want to check what file synctool is using for a given destination
file, use option <code>-ref</code> or <code>-r</code>:</p>

<pre><code>root@masternode:/# synctool -q -n node1 -r /etc/resolv.conf
node1: /etc/resolv.conf._somegroup
</code></pre>

<p>synctool can be run on a subset of nodes, a group, or even on individual
nodes using the options <code>--node</code> or <code>-n</code>, <code>--group</code> or <code>-g</code>, <code>--exclude</code>
or <code>-x</code>, and <code>--exclude-group</code> or <code>-X</code>. This also works for <code>dsh</code> and friends,
and you may use the range syntax to select a range of nodes.
For example:</p>

<pre><code># synctool -g batch,sched -X rack8
</code></pre>

<p>More examples:</p>

<pre><code># dsh -n node1,node2,node3 date
# dsh -n node[1-3] date
# dsh -n node[01-10] -x node[05-07] hostname
# dsh -n node[02-10/2,05,07] hostname
</code></pre>

<p>Copy a file to three nodes:</p>

<pre><code># dsh-cp -n node[1-3] patchfile-1.0.tar.gz /tmp
</code></pre>

<p>After rebooting a cluster, use <code>dsh-ping</code> to see if the nodes respond to ping
yet. You may also do this on a group of nodes:</p>

<pre><code># dsh-ping -g rack4
</code></pre>

<p>The option <code>-v</code> gives verbose output. This is another way of displaying
the logic that synctool performs:</p>

<pre><code># synctool -v
node3: checking $overlay/all/etc/tcpd_banner.production._all
node3: overridden by $overlay/all/etc/tcpd_banner.production._batch
node3: checking $overlay/all/etc/issue.net.production._all
node3: checking $overlay/all/etc/syslog.conf._all
node3: checking $overlay/all/etc/issue.production._all
node3: checking $overlay/all/etc/modules.conf._all
node3: checking $overlay/all/etc/hosts.allow.production._interactive
node3: skipping $overlay/all/etc/hosts.allow.production._interactive,
it is not one of my groups
</code></pre>

<p>The option <code>--unix</code> produces UNIX-style output. This shows in standard shell
syntax just what synctool is about to do.</p>

<pre><code>root@masternode:/# synctool --unix
node3: # updating file /etc/xinetd.d/identd
node3: mv /etc/xinetd.d/identd /etc/xinetd.d/identd.saved
node3: umask 077
node3: cp /var/lib/synctool/overlay/etc/xinetd.d/identd._all
/etc/xinetd.d/identd
node3: chown root.root /etc/xinetd.d/identd
node3: chmod 0644 /etc/xinetd.d/identd
</code></pre>

<blockquote>
  <p>synctool does not apply changes by executing shell commands; all
operations are programmed in Python. The option <code>--unix</code> is only a way of
displaying what synctool does, and may be useful when debugging.</p>
</blockquote>

<p>The option <code>-T</code> option produces terse output. In terse mode, long paths are
abbreviated in an attempt to fit them on a single line of 80 characters wide.
Terse mode can be made to give colored output through <code>synctool.conf</code>.</p>

<pre><code>root@masternode# synctool -n n1 -T
n1: DRYRUN not doing any updates
n1: mkdir /Users/walter/src/.../testroot/etc/cron.daily
n1: new /Users/walter/src/.../testroot/etc/cron.daily/testfile
n1: exec //overlay/Users/.../testroot/etc/cron.daily.post
</code></pre>

<p>Note that these abbreviated paths can still be copy-and-pasted and used with
other synctool commands like <code>--single</code> and <code>--diff</code>. synctool will recognize
the abbreviated path and expand it on the fly. In the case of any name clashes
synctool will report this and present a list of possibilities for you to
consider.</p>

<p>The option <code>--skip-rsync</code> skips the <code>rsync</code> run that copies the repository
from the master to the client node. You may use this option when you are
absolutely certain that the master and client are already in sync, for example
if you just ran synctool to examine any changes. In general, this option is
unnecessary, but it may be efficient if you are working with slow network
links or a large synctool repository.</p>

<h2>3.4 Templates</h2>

<p>For &#8216;dynamic&#8217; config files, synctool has a feature called templates.
There are a number of rather standard configuration files that (for example)
require the IP address of a node to be listed. These are not particularly
synctool friendly. You are free to upload each and every unique instance
of the config file in question into the repository, however, if your cluster
is large this does not make your repository look very nice, nor does it
make them any easier to handle. Instead, make a template and couple it with
a <code>._template.post</code> script that calls <code>synctool-template</code> to generate the
config file on the node.</p>

<p>As an example, I will use a fictional snippet of config file, but this
trick applies to things like <code>sshd_config</code> with a specific <code>ListenAddress</code>
in it, and network configuration files that have static IPs configured.</p>

<pre><code># fiction.conf._template
MyPort 22
MyIPAddress @IPADDR@
SomeOption no
PrintMotd yes
</code></pre>

<p>And the accompanying <code>fiction.conf._template.post</code> script:</p>

<pre><code>#! /bin/sh
IPADDR=`ifconfig en0 | awk '/inet / { print $2 }'`
export IPADDR
/opt/synctool/bin/synctool-template "$1" &gt;"$2"
</code></pre>

<p>This example uses <code>ifconfig</code> to get the IP address of the node. You may also
use the <code>ip addr</code> command, consult DNS or you might be able to use
<code>synctool-config</code> to get what you need.</p>

<p>The <code>synctool-template</code> command takes as input the template file (&#8220;<code>$1</code>&#8221;)
and redirects the output to a newly generated file (&#8220;<code>$2</code>&#8221;). The &#8220;<code>$2</code>&#8221;
on the last line expands to <code>fiction.conf._nodename</code>.
Hence, synctool generates a new config file in the repository. It does so
even on dry runs; you can ask synctool to display a diff of <code>fiction.conf</code>
even though it is templated.</p>

<blockquote>
  <p>Note <em>not</em> to redirect the output of <code>synctool-template</code> directly over
the target file. Doing that is destructive and wrong; it defies synctool&#8217;s
dry-run mode and keeps you from being able to review changes, a core
function of synctool.</p>
</blockquote>

<p>Instead of using <code>synctool-template</code>, you might use the UNIX <code>sed</code> command.
If you have multiple variables to replace, <code>synctool-template</code> is more easy.
synctool-template accepts variables either from the command-line or from
the shell environment. Like with regular <code>.post</code> scripts, the environment
variables <code>SYNCTOOL_NODE</code> and <code>SYNCTOOL_ROOT</code> are also present here.
However <em>unlike</em> regular <code>.post</code> scripts, template post scripts require a <code>#!</code>
hashbang line. This is required for shell arguments (like &#8220;<code>$1</code>&#8221;, &#8220;<code>$2</code>&#8221;)
to work.</p>

<p>Now, when you want to change the configuration, edit the template file.
synctool will fill in the template and see the difference with the target
file.</p>

<p>Template files and template post scripts can have group extensions to
select different templates for certain groups of nodes.</p>

<p>If you want to automatically reload or restart a service after updating
<code>fiction.conf</code>, you&#8217;ll also have to implement a regular <code>.post</code> script for
that: <code>fiction.conf.post</code>.</p>

<h2>3.5 Purge directories</h2>

<p>In the previous sections we saw how you can use the <code>overlay/</code> and <code>delete/</code>
trees to manage your cluster. synctool has a third mechanism of syncing
files, and it works with the <code>purge/</code> tree. Purge directories are great for
mirroring entire directory trees to groups of nodes.</p>

<p>Unlike with the <code>overlay/</code> tree, files in the <code>purge/</code> tree do not have group
extensions. Instead, synctool will copy the entire subtree and it will
<em>delete</em> any files on the target node that do not reside in the source tree.
So, it will make a perfect mirror of the source under <code>purge/</code>.</p>

<p>To populate the <code>purge/</code> tree, use <code>--upload</code> with the <code>--purge</code> option:</p>

<pre><code># synctool -n n1 --upload /usr/local --purge compute
# synctool -n n1 -u /usr/local -p compute
</code></pre>

<p>In this example, we want to upload the entire <code>/usr/local</code> tree from node <code>n1</code>
to the repository directory <code>/opt/synctool/var/purge/compute/</code>.
Afterwards, all compute nodes will get <code>/usr/local</code> synced via the purge
mechanism by running <code>synctool -f</code>.</p>

<blockquote>
  <p>Purging is a blunt but effective means to synchronise directory trees.
Mind that it will delete data that is not supposed to be there, so be
careful with this feature. For added safety, synctool will not allow you
to purge the root directory of a system.</p>
</blockquote>

<p>Under the hood, synctool employs <code>rsync</code> to purge files. Hence, you can not
trigger actions through <code>.post</code> scripts in the purge directory, but it is
possible to use <code>synctool --diff</code>, <code>--ref</code>, and even <code>--single</code> with files
that reside under <code>purge/</code>.</p>

<p>Remember that purging is for making perfect mirrors. It is like sharing a
directory across nodes. Once you start differentiating directory content
between nodes, &#8220;purge&#8221; will no longer work in a satisfying way; in such a
case, you should really use <code>overlay/</code> rather than <code>purge/</code>.</p>

<p><code>dsh-cp</code> also has an option <code>--purge</code> to quickly mirror directories across
nodes. Use with care.</p>

<h2>3.6 The order of operations</h2>

<p>The previous sections described a lot of operations that synctool performs
when it runs. This section summarises what we have seen so far.
For a normal synctool run, the order of operations is roughly as follows.</p>

<ol>
<li>synchronise the synctool installdir to each node. This synchronises
the repository as well as the main program and config file.
Any subtrees under <code>overlay</code>, <code>delete</code>, and <code>purge</code> that do not apply for
the target node, are excluded.</li>
<li>run synctool-client on the nodes</li>
<li>synctool-client mirrors the <code>purge</code> directory</li>
<li>synctool-client processes the <code>overlay</code> directory;
<ul>
<li>generate templates by running <code>.template.post</code> scripts</li>
<li>compare files
<ul>
<li>check filetype</li>
<li>check file size</li>
<li>check MD5 checksum</li>
<li>check file ownership</li>
<li>check file mode</li>
</ul></li>
<li>make backup copies</li>
<li>update files as needed</li>
<li>run <code>.post script</code> for any updated files</li>
<li>run <code>.post script</code> (if any) for changed directories</li>
</ul></li>
<li>synctool-client deletes files listed in the <code>delete</code> directory
<ul>
<li>run <code>.post script</code> (if any) for deleted files</li>
<li>run <code>.post script</code> (if any) for changed directories</li>
</ul></li>
</ol>

<h2>3.7 dsh-pkg, the synctool package manager</h2>

<p>synctool comes with a package manager named <code>dsh-pkg</code>.
Rather than being yet another package manager with its own format of packages,
dsh-pkg is a wrapper around existing package management software.
dsh-pkg unifies all the different package managers out there so you can
operate any of them using just one command and the same set of command-line
arguments. This is particularly useful in heterogeneous clusters or when
you are working with multiple platforms or distributions.</p>

<p>dsh-pkg supports a number of different package management systems and will
detect the appropriate package manager for the operating system of the node.
If detection fails, you may force the package manager on the command-line or
in <code>synctool.conf</code>:</p>

<pre><code>#package_manager apk
package_manager apt-get
#package_manager brew
#package_manager bsdpkg
#package_manager dnf
#package_manager pacman
#package_manager pkg
#package_manager yum
#package_manager zypper
</code></pre>

<p>dsh-pkg knows about more platforms and package managers, but currently
only the ones listed above are implemented and supported.</p>

<blockquote>
  <p>dsh-pkg is pluggable. Adding support for other package management systems
is rather easy. If your platform and/or favorite package manager is not yet
supported, feel free to develop your own plug-in for dsh-pkg
or contact the author of synctool.</p>
</blockquote>

<p>The <code>pkg</code> module is for FreeBSD, use <code>bsdpkg</code> on other BSD systems.</p>

<p>Following are examples of how to use synctool-pkg.</p>

<pre><code>dsh-pkg -n node1 --list
dsh-pkg -n node1 --list wget
dsh-pkg -g batch --install lynx wget curl
dsh-pkg -g batch -x node3 --remove somepackage
</code></pre>

<p>Sometimes you need to refresh the contents of the local package database.
You can do this with the &#8216;update&#8217; command:</p>

<pre><code>dsh-pkg -qa --update
</code></pre>

<p>You may check for software upgrades for the node with <code>--upgrade</code>.
This will only show what upgrades are available. To really upgrade a node,
specify <code>--fix</code>. It is wise to always test an upgrade on a single node.</p>

<pre><code>dsh-pkg --upgrade
dsh-pkg -n testnode --upgrade -f
dsh-pkg --upgrade -f
</code></pre>

<p>Package managers download their packages into an on-disk cache. Sometimes the
disk fills up and you may want to clean out the disk cache:</p>

<pre><code>dsh-pkg -qa --clean
</code></pre>

<p>A specific package manager may be selected from the command-line.</p>

<pre><code>dsh-pkg -m yum -i somepackage   # force it to use yum
</code></pre>

<p>If you want to further examine what dsh-pkg is doing, you may specify
<code>--verbose</code> or <code>--unix</code> to display more information about what is going on
under the hood.</p>

<h2>3.8 Ignoring them: I&#8217;m not touching you</h2>

<p>By using directives in the <code>synctool.conf</code> file, synctool can be told to
ignore certain files, nodes, or groups. These will be excluded, skipped.
For example:</p>

<pre><code>ignore_dotfiles no
ignore_dotdirs yes
ignore .svn
ignore .gitignore .git
ignore .*.swp
</code></pre>

<p>synctool will not run on ignored nodes or on nodes that are in a group that
is ignored:</p>

<pre><code>ignore_node node1 node2
ignore_group broken
</code></pre>

<h2>3.9 Backup copies</h2>

<p>For any file synctool updates, it keeps a backup copy around on the target
node with the extension <code>.saved</code>. If you don&#8217;t like this, you can tell
synctool to not make any backup copies with:</p>

<pre><code>backup_copies no
</code></pre>

<p>It is however highly recommended that you run with <code>backup_copies</code> enabled.
You can manually specify that you want to remove backup copies using:</p>

<pre><code>synctool --erase-saved
synctool -e
</code></pre>

<p>To erase a single <code>.saved</code> file, use option <code>--single</code> in combination with
<code>--erase-saved</code>.</p>

<p>For some (Linux) directories like <code>/etc/cron.d/</code> and <code>/etc/xinet.d/</code>, it is
not OK to keep <code>.saved</code> files around because it influences how the daemons
function. For these directories it is recommended that you implement
a <code>.post</code> script that removes the backup copies, like so:</p>

<pre><code># $overlay/all/etc/xinetd.d.post
rm -f *.saved
service xinetd reload
</code></pre>

<p>Alternatively, you may want to move the backup copies to a safe location.</p>

<h2>3.10 Logging</h2>

<p>When using option <code>--fix</code> to apply changes, synctool logs the made changes
to syslog on the master node. It provides a trace of what was changed on the
systems. On large clusters, this may produce a lot of log records. If you
don&#8217;t want any logging, you can disable it in <code>synctool.conf</code>:</p>

<pre><code>syslogging no
</code></pre>

<p>When you do use syslogging, you may want to split off the synctool messages
to a separate file like <code>/var/log/synctool.log</code>. Please see your <code>syslogd</code>
manual on how to do this. In the <code>contrib/</code> directory in the synctool source,
you will find config files for use with <code>syslog-ng</code> and <code>logrotate</code>.</p>

<h2>3.11 About symbolic links</h2>

<p>synctool requires all files in the repository to have an extension (well &#8230;
unless you changed the default configuration), and symbolic links must have
extensions too. Symbolic links in the repository will be <em>dead</em> symlinks but
they will point to the correct destination on the target node.</p>

<p>Consider the following example, where <code>file</code> does not exist &#8216;as is&#8217; in the
repository:</p>

<pre><code>$overlay/all/etc/motd._red -&gt; file
$overlay/all/etc/file._red
</code></pre>

<p>In the repository, <code>motd._red</code> is a red &amp; dead symlink to <code>file</code>. On the
target node, <code>/etc/motd</code> is going to be fine.</p>

<h2>3.12 Slow updates</h2>

<p>By default, synctool addresses the nodes in parallel, and they are running
updates concurrently. In some cases you might not want to have any
parallelism. There are two easy ways around this;</p>

<pre><code>dsh --numproc=1 uptime
dsh -p 1 uptime

dsh --zzz=10 uptime
dsh -z 10 uptime
</code></pre>

<p>The first one tells synctool (or in this case, <code>dsh</code>) to run only one
process at a time. The second does the same thing, and sleeps for ten seconds
after running the command.</p>

<blockquote>
  <p>Suppose you have a 60 nodes cluster, and run with <code>--zzz=60</code>.
You now have to wait at least one hour for the run to complete.</p>
</blockquote>

<p>The options <code>--numproc</code> and <code>--zzz</code> work for both <code>synctool</code> and <code>dsh</code>
programs.</p>

<h2>3.13 Checking for updates</h2>

<p>synctool can check whether a new version of synctool itself is available by
using the option <code>--check-update</code> on the master node. You can check
periodically for updates by using <code>--check-update</code> in a crontab entry.
To download the latest version, run <code>synctool --download</code> on the master node.
These functions connect to the main website at <a href="http://www.heiho.net/synctool/">www.heiho.net/synctool</a>.</p>

<h2>3.14 Running tasks with synctool</h2>

<p>synctool&#8217;s <code>dsh</code> command is ideal for running commands on groups of nodes.
On occasion, you will also want to run custom scripts with <code>dsh</code>.
These scripts can be placed in <code>scripts/</code>, and <code>dsh</code> will find them.
When running a command that resides under <code>scripts/</code>, <code>dsh</code> will sync this
script to the target node prior to running the command on the remote side.
This is done to make sure that always the &#8216;current&#8217; version of the script
runs on the target node.</p>

<p>For example, if you have a script <code>/opt/synctool/scripts/admin_example.sh</code>
then you might run:</p>

<pre><code>dsh -n node1 admin_example.sh
</code></pre>

<p>No path to the script is required; dsh will find it.</p>

<blockquote>
  <p>Old versions had a <code>tasks/</code> directory under the repository and you
could invoke synctool with the <code>--tasks</code> option. This mechanism has been
obsoleted by <code>dsh</code> and the <code>scripts/</code> directory.</p>
</blockquote>

<p>Note that you can write scripts to do software package installations,
but you may also use the <code>dsh-pkg</code> command.</p>

<h2>3.15 Multiplexed connections</h2>

<p>synctool and dsh can multiplex SSH connections over a &#8216;master&#8217; connection.
This feature greatly speeds up synctool and dsh because it allows skipping
the costly SSL handshake.
Multiplexing is started through dsh:</p>

<pre><code>dsh -M          # start master connections
dsh -O check    # check master connections
dsh -O stop     # stop master connections
dsh -O exit     # terminate master connections
</code></pre>

<p>You may also do this for certain groups or nodes, like so:</p>

<pre><code>dsh -g all -M
dsh -n node1 -O check
</code></pre>

<p>synctool will detect any open control paths and use them if they are present.
The control paths (socket files) to each node are kept under synctool&#8217;s temp
directory (by default: <code>/tmp/synctool/sshmux/</code>).
These control paths are managed by ssh mux processes that are running in the
background. If your cluster is very large, you might find the large number of
ssh mux processes on the management node to be objectionable. These processes
are mostly sleeping so it shouldn&#8217;t pose a problem.
The control paths may be given a timeout by using the config parameter
<code>ssh_control_persist</code>. Note that this parameter is only supported for
OpenSSH 5.6 and later. The timeout may also be specified on the command-line:</p>

<pre><code>dsh -M --persist 4h
</code></pre>

<blockquote>
  <p>The <code>ControlMaster</code> and <code>ControlPath</code> options of ssh first appeared in
OpenSSH version 3.9. synctool also supports <code>ControlPersist</code>, which is
present in OpenSSH version 5.6 and later.
See <code>man ssh_config</code> for more information on these OpenSSH options.</p>
</blockquote>
<br /><br /><div class="line"> </div><br /> 
<h1>4. All configuration parameters explained</h1>

<p>This chapter lists and explains all parameters that you can use in
synctool&#8217;s configuration file.</p>

<ul>
<li><p><code>backup_copies &lt;yes/no&gt;</code></p>

<p>When set to &#8216;yes&#8217;, synctool creates backup copies on the target nodes of
files that it updates. These backup files will be named <code>*.saved</code>.
The default for this parameter is <code>yes</code>.</p></li>
<li><p><code>colorize &lt;yes/no&gt;</code></p>

<p>In terse mode, synctool output can be made to show colors. Mind that this
parameter only works when <code>terse</code> is set to <code>yes</code>.
The default is <code>yes</code>.</p></li>
<li><p><code>color_info &lt;color&gt;</code></p>

<p>Specify the color for informational messages in terse mode.
The default is <code>default</code>.</p>

<p>Following are keywords to customize colors. Valid color codes are:</p>

<pre><code>white       red       blue       default
black       green     magenta    bold
darkgray    yellow    cyan
</code></pre></li>
<li><p><code>color_warn &lt;color&gt;</code></p>

<p>Specify the color for warnings in terse mode.
The default is <code>magenta</code>.</p></li>
<li><p><code>color_error &lt;color&gt;</code></p>

<p>Specify the color for error messages in terse mode.
The default is <code>red</code>.</p></li>
<li><p><code>color_fail &lt;color&gt;</code></p>

<p>Specify the color for failure messages in terse mode.
The default is <code>red</code>.</p></li>
<li><p><code>color_sync &lt;color&gt;</code></p>

<p>Specify the color for <em>sync</em> messages in terse mode. These occur
when synctool synchronizes file data.
The default is <code>default</code>.</p></li>
<li><p><code>color_link &lt;color&gt;</code></p>

<p>Specify the color for <em>link</em> messages in terse mode. These occur
when synctool creates or repairs a symbolic link.
The default is <code>cyan</code>.</p></li>
<li><p><code>color_mkdir &lt;color&gt;</code></p>

<p>Specify the color for <em>mkdir</em> messages in terse mode. These occur
when synctool creates a driectory.
The default is <code>default</code>.</p></li>
<li><p><code>color_rm &lt;color&gt;</code></p>

<p>Specify the color for <em>rm</em> messages in terse mode. These occur when
synctool deletes a file.
The default is <code>yellow</code>.</p></li>
<li><p><code>color_chown &lt;color&gt;</code></p>

<p>Specify the color for <em>chown</em> messages in terse mode. These occur
when synctool changes the ownership of a file or directory.
The default is <code>cyan</code>.</p></li>
<li><p><code>color_chmod &lt;color&gt;</code></p>

<p>Specify the color for <em>chmod</em> messages in terse mode. These occur
when synctool changes the access mode of a file or directory.
The default is <code>cyan</code>.</p></li>
<li><p><code>color_exec &lt;color&gt;</code></p>

<p>Specify the color for <em>exec</em> messages in terse mode. These occur
when synctool executes a <code>.post</code> script.
The default is <code>green</code>.</p></li>
<li><p><code>color_upload &lt;color&gt;</code></p>

<p>Specify the color for <em>upload</em> messages in terse mode. These occur
when you use synctool to upload a file.
The default is <code>magenta</code>.</p></li>
<li><p><code>color_new &lt;color&gt;</code></p>

<p>Specify the color for <em>new</em> messages in terse mode. These occur when
a sync operation requires synctool to create a new file.
The default is <code>default</code>.</p></li>
<li><p><code>color_type &lt;color&gt;</code></p>

<p>Specify the color for <em>type</em> messages in terse mode. These occur when
the file type of the entry in the repository does not match the file type
of the target file.
The default is <code>magenta</code>.</p></li>
<li><p><code>color_dryrun &lt;color&gt;</code></p>

<p>Specify the color for the &#8216;DRYRUN&#8217; message in terse mode.
It occurs when synctool performs a dry run.
The default is <code>default</code>.</p></li>
<li><p><code>color_fixing &lt;color&gt;</code></p>

<p>Specify the color for the &#8216;FIXING&#8217; message in terse mode.
It occurs when synctool is run with the <code>--fix</code> option.
The default is <code>default</code>.</p></li>
<li><p><code>color_ok &lt;color&gt;</code></p>

<p>Specify the color for the &#8216;OK&#8217; message in terse mode.
It occurs when files are up to date.
The default is <code>default</code>.</p></li>
<li><p><code>colorize_bright &lt;yes/no&gt;</code></p>

<p>In terse mode, synctool output can be made to show colors. This option
enables the bright/bold attribute for colors.
Mind that this parameter only works when both <code>terse</code> and <code>colorize</code>
are enabled.
The default is <code>yes</code>.</p></li>
<li><p><code>colorize_bold &lt;yes/no&gt;</code></p>

<p>Same as <code>colorize_bright</code>.</p></li>
<li><p><code>colorize_full_line &lt;yes/no&gt;</code></p>

<p>In terse mode, synctool output can be made to show colors. This option
colors the full output line rather than just the leading keyword.
Mind that this parameter only works when both <code>terse</code> and <code>colorize</code>
are enabled.
The default is <code>no</code>.</p></li>
<li><p><code>default_nodeset &lt;group-or-node&gt; [..]</code></p>

<p>By default, synctool will run on these nodes or groups. You can use this to
make synctool by default work on only a subcluster rather than your whole
hardware installation.</p>

<p>The default is <code>all</code>. You may set it to <code>none</code> to make synctool not run
on a default set of nodes at all. Example:</p>

<pre><code>default_nodeset test1 test2 testnodes xtest[1-10]
</code></pre></li>
<li><p><code>diff_cmd &lt;diff UNIX command&gt;</code></p>

<p>Give the command and arguments to execute <code>diff</code>.
synctool runs this command when you use the option <code>--diff</code> to see the
differences between the file in the repository and on the target node.</p>

<p>The exact location and arguments of the <code>diff</code> program are operating
system specific; the PATH environment variable will be searched for the
command if you do not supply a full path.</p>

<p>The default is: <code>diff -u</code></p></li>
<li><p><code>full_path &lt;yes/no&gt;</code></p>

<p>synctool likes to abbreviate paths to <code>$overlay/some/dir/file</code>.
When you set this option to <code>no</code>, synctool will display the true full path
instead of the abbreviated one.</p>

<p>The default is <code>no</code>.</p></li>
<li><p><code>group &lt;groupname&gt; &lt;subgroup&gt; [..]</code></p>

<p>The <code>group</code> keyword defines <em>compound</em> groups. It is a means to group
several subgroups together into a single group. If the subgroups did not
exist yet, they are defined automatically as new, empty groups.</p>

<pre><code>group wn workernode batch
group test wn
group g1 batch test wn
</code></pre>

<p>Group names are alphanumeric, but can have an underscore, minus, or plus
symbol in between. The following are valid group names:</p>

<pre><code>group group1 group-1 group_1 group+1 192_168_1 10 node1+node2
group A+B+C A B C
</code></pre></li>
<li><p><code>ignore &lt;filename or directory name&gt; [..]</code></p>

<p>This parameter enables you to have synctool ignore specific files or
directories in the repository. Multiple <code>ignore</code> definitions are allowed.
You may put multiple filenames on a line, and you may use wildcards.
Example:</p>

<pre><code>ignore .gitignore .git .svn
ignore .*.swp
ignore tmp[0-9][0-9][0-9]??
</code></pre></li>
<li><p><code>ignore_dotfiles &lt;yes/no&gt;</code></p>

<p>Setting this to &#8216;yes&#8217; results in synctool ignoring all files in the
repository that begin with a dot. This can be convenient like for example
for <code>.gitignore</code>.
The default is <code>no</code>; do not ignore dotfiles.</p></li>
<li><p><code>ignore_dotdirs &lt;yes/no&gt;</code></p>

<p>Setting this to &#8216;yes&#8217; results in synctool ignoring all directories in the
repository that begin with a dot. This can be convenient like for example
for <code>.svn/</code> directories.
The default is <code>no</code>; do not ignore dotdirs.</p></li>
<li><p><code>ignore_group &lt;group&gt; [..]</code></p>

<p>This tells synctool to ignore one or more groups. You can use this to
temporarily disable the group. This can be particularly useful when doing
software upgrades.</p></li>
<li><p><code>ignore_node &lt;nodename&gt; [..]</code></p>

<p>This tells synctool to ignore one or more nodes. You can use this if you
want to skip this node for a while for some reason, for example because
it is broken.</p></li>
<li><p><code>include &lt;(local) synctool config file&gt;</code></p>

<p>This keyword includes a synctool configuration file (that is possibly
located on the target node). You can use this to give certain nodes a
slightly different synctool configuration than others. This can be
important, especially in setups where you are running a multitude of
operating systems.</p>

<pre><code>include /etc/synctool_local.conf
</code></pre>

<p>Another good use of this option is to clean up your configuration:</p>

<pre><code>include /opt/synctool/etc/nodes.conf
include /opt/synctool/etc/colors.conf
</code></pre></li>
<li><p><code>master &lt;fqdn&gt;</code></p>

<p>Indicates which node is the master, the management node from where you
will run synctool to control the cluster. It should be set to the fully
qualified domain name of the management host. You can get the fqdn with:</p>

<pre><code>synctool-config --fqdn
</code></pre></li>
<li><p><code>node &lt;nodename&gt; &lt;group&gt; [..] [ipaddress:&lt;name, IP address, or sequence&gt;]
[rsync:&lt;yes/no&gt;]</code></p>

<p>The <code>node</code> keyword defines what groups a node is in. Multiple groups may
be given. The order of the groups is important; the left-most group is most
important, and the right-most group is least important. What this means is
that if there are files in repository that have the same base filename,
but a different group extension, synctool will pick the file that has the
most important group extension for this node.</p>

<p>Groups can be defined &#8216;on the fly&#8217;, there is no need for a group to exist
before it can be used in a node definition.</p>

<p>Node names are alphanumeric, but can have an underscore, minus, or plus
symbol in between. The following are valid node names:</p>

<pre><code>node node1 node-1 node_1 node+1 10_0_0_2 10 node1+node2
</code></pre>

<p>The <code>ipaddress</code> specifier tells synctool how to contact the node. This is
optional; when omitted, synctool assumes the nodename can be found in DNS.
Note that synctool nodenames need not be same as DNS names.</p>

<blockquote>
  <p>The synctool master tells the clients what node they are.
When running synctool-client in stand-alone mode, the client tries to
figure out by itself what node it is running on. If it fails to determine
the nodename, you may pass option <code>--nodename</code> to force it.</p>
</blockquote>

<p>The optional <code>rsync:no</code> specifier may be used to tell synctool not
to sync the repository to the target node. This is only convenient when
the node has access to the repository via another way, such as a shared
filesystem.</p>

<pre><code>node node1 fs sched rack1
node node2 login    rack1
node node3 test     rack1 ipaddress:node8-mgmt
node node4 batch    rack1 ipaddress:node9-mgmt rsync:no
node node5 wn       rack1 ipaddress:node5-mgmt
node node6 wn       rack1 ipaddress:node6-mgmt
node node7 wn       rack1 ipaddress:node7-mgmt
node node[20-29] wn rack2 ipaddress:node[20]-mgmt
node node[30-39] wn rack3 ipaddress:192.168.3.[130]
</code></pre>

<p>As shown in this example, a node range may be given to define a number
of nodes using a single definition line. The (optional) IP address may
use the sequence notation, that numbers the IP addresses in sequence.</p></li>
<li><p><code>num_proc &lt;number&gt;</code></p>

<p>This specifies the maximum amount of parallel processes that synctool
will use. For large clusters, you will want to increase this value, but mind
that this will increase the load on your master node. Setting this value
higher than the amount of nodes you have, has no effect.
The default is <code>16</code>.</p>

<p>For synctool, dsh, dsh-pkg and the like, option <code>--numproc</code> can be given
to override this setting.</p></li>
<li><p><code>package_manager &lt;package management system&gt;</code></p>

<p>Specify the package management system that dsh-pkg must use.
If left out, dsh-pkg will detect what package manager it should use,
but using this parameter you can force it if detection fails.
This setting can be overridden from the command-line when invoking
<code>dsh-pkg</code>.</p>

<p>Valid values for <code>package_manager</code> are:</p>

<pre><code>apk
apt-get
brew
bsdpkg
dnf
pacman
pkg
yum
zypper
</code></pre></li>
<li><p><code>pkg_cmd &lt;synctool-client-pkg UNIX command&gt;</code></p>

<p>Give the command and arguments to execute <code>synctool-client-pkg</code>.
dsh-pkg uses this command to do package management on the target nodes.</p>

<p>The exact location of the <code>synctool-client-pkg</code> program is installation
dependent. However, dsh-pkg looks for it under the synctool root.</p>

<p>The default is: <code>$SYNCTOOL/bin/synctool-client-pkg</code></p></li>
<li><p><code>ping_cmd &lt;ping UNIX command&gt;</code></p>

<p>Give the command and arguments to execute <code>ping</code>.
<code>dsh-ping</code> uses this command to check what nodes are up and running.</p>

<p>The exact location and arguments of the <code>ping</code> program are operating
system specific; the PATH environment variable will be searched for the
command if you do not supply a full path.</p>

<p>The default is: <code>ping -q -c 1 -w 1</code> (which assumes Linux ping options)</p></li>
<li><p><code>require_extension &lt;yes/no&gt;</code></p>

<p>When set to &#8216;yes&#8217;, a generic file in the repository must have the extension
<code>'.all'</code>. When set to &#8216;no&#8217; an extension is not required and the group
<code>all</code> is automatically implied.
The default is <code>yes</code>.</p></li>
<li><p><code>rsync_cmd &lt;rsync UNIX command&gt;</code></p>

<p>Give the command and arguments to execute <code>rsync</code>. synctool uses this
command to distribute the repository to the target nodes.</p>

<p>The exact location of the <code>rsync</code> program is operating system specific;
the PATH environment variable will be searched for the command if you do
not supply a full path.</p>

<p>The default is: <code>rsync -ar --delete --delete-excluded -e 'ssh
-o ConnectTimeout=10 -x -q' -q</code></p>

<p>synctool will automatically add another option <code>--filter</code> to this command,
which it uses to ensure that the correct overlay directories are synced
to the nodes. So be mindful that you can tweak the parameters of the
<code>rsync</code> command, but you can not replace it with a different copying
program &#8212; unless it also supports <code>rsync</code>&#8217;s filtering capabilities.</p></li>
<li><p><code>slave &lt;nodename&gt; [..]</code></p>

<p>Slave nodes get a full copy of the synctool repository. Slaves have no
other function than that. You can not run synctool from a slave until you
change it into a master node in the config file.</p></li>
<li><p><code>ssh_cmd &lt;ssh UNIX command&gt;</code></p>

<p>Give the command and arguments to execute <code>ssh</code>. synctool and <code>dsh</code> use
this command to execute remote commands on the target nodes.</p>

<p>The exact location of the <code>ssh</code> program is operating system specific;
the PATH environment variable will be searched for the command if you do
not supply a full path.</p>

<p>The default is: <code>ssh -o ConnectTimeout=10 -x -q</code></p></li>
<li><p><code>ssh_control_persist &lt;time|yes|none&gt;</code></p>

<p>This parameter maps directly to the OpenSSH <code>ControlPersist</code>.
It sets the default timeout for multiplexed connections, using <code>dsh -M</code>.
This parameter may be overridden on the command-line with <code>dsh --persist</code>.
The time argument is a string like &#8220;1h&#8221; or &#8220;1h30m&#8221;. When it is &#8220;yes&#8221;,
there is no timeout, and it will persist indefinitely until the master
is stopped or terminated with <code>dsh -O stop</code> or <code>dsh -O exit</code>.
Note that OpenSSH supports <code>ControlPersist=no</code>, but synctool does not.
It can be set to <code>none</code> to call <code>ssh</code> without <code>-o ControlPersist</code> option.
The default timeout is 1 hour. This parameter only has effect for OpenSSH
version 5.6 and later.</p></li>
<li><p><code>sync_times &lt;yes/no&gt;</code></p>

<p>Synchronize modification timestamps of files. Every file on the node
will get the timestamp identical to the file in the overlay.
Template generated files will get the timestamp of the template.</p>

<p>This setting only works for files (and special files).
Timestamps of symbolic links and directories are not managed.</p>

<p>The default is: <code>no</code>.</p></li>
<li><p><code>synctool_cmd &lt;synctool UNIX command&gt;</code></p>

<p>Give the command and arguments to execute <code>synctool-client</code>. synctool uses
this command to execute synctool on the target nodes.</p>

<p>The exact location of the <code>synctool-client</code> program is installation
dependent. However, synctool looks for it under the synctool root.</p>

<p>The default is: <code>$SYNCTOOL/bin/synctool-client</code></p></li>
<li><p><code>syslogging &lt;yes/no&gt;</code></p>

<p>Log any updates to syslog. Nothing is logged for dry runs.
The default is: <code>yes</code>.</p></li>
<li><p><code>tempdir &lt;directory&gt;</code></p>

<p>Directory where the synctool master will create temporary files.
The default is <code>/tmp/synctool</code>. There may be only one <code>tempdir</code> defined
and it must be an absolute path.</p></li>
<li><p><code>terse &lt;yes/no&gt;</code></p>

<p>In terse mode, synctool shows a very brief output with paths abbreviated
to <code>//overlay/dir/.../file</code>.
The default is <code>no</code>.</p></li>
</ul>
<br /><br /><div class="line"> </div><br /> 
<h1>5. Best practices</h1>

<p>This chapter contains tips, tricks and examples of how to make good use of
synctool.</p>

<h2>5.1 Use logical group names</h2>

<p>synctool allows you to use nodenames as extension on files in the repository.
This is nice because it allows you to easily differentiate for a single node.
However, it is much better practice to put that node in a certain group, and
let it be the only member of that group. Now label the file as belonging to
that group, and you&#8217;re done.</p>

<p>Bad:</p>

<pre><code>overlay/all/etc/hosts.allow._all
overlay/all/etc/hosts.allow._node1
overlay/all/etc/motd._all
overlay/all/etc/motd._node1
</code></pre>

<p>Good:</p>

<pre><code>overlay/mycluster/etc/hosts.allow._all
overlay/mycluster/etc/hosts.allow._login
overlay/mycluster/etc/motd._all
overlay/mycluster/etc/motd._login
</code></pre>

<p>The advantage is that you will be able to shift the service to another node
simply by changing the synctool configuration, rather than having to rename
all files in the repository.</p>

<h2>5.2 Future planning: Be mindful of group &#8216;all&#8217;</h2>

<p>synctool has this great group &#8216;all&#8217; that applies to all nodes. One day,
however, you decide to add a new machine to your cluster that has a pretty
different role than any other. (Not) suprisingly, synctool will want to apply
all files tagged as <code>all</code> to the new node &#8212; but in this case, it&#8217;s exactly
<em>not</em> what you want.</p>

<p>The problem is that <code>all</code> is too generic, and the solution is to rename
<code>overlay/all/</code> to something else, such as <code>overlay/common/</code>, or better yet,
<code>overlay/subcluster1/</code>. This moves <code>all</code> out of the way and you can integrate
your new node in a better way.</p>

<p>The lesson here is that <code>overlay/all/</code> is a nice catch-all directory, but
it&#8217;s maybe best left unused. It&#8217;s perfectly OK for files to be tagged as
<code>._all</code>, but they really should be placed in a group-specific overlay
directory.</p>

<h2>5.3 Use group extensions on directories sparingly</h2>

<p>synctool allows you to add a group extension to a directory, like so:</p>

<pre><code>$overlay/all/etc._mygroup/
</code></pre>

<p>This is a powerful feature. However, it can make a mess of your repository
as well. If you catch yourself having to use <code>find</code> all the time to pinpoint
the location of a file in the repository, chances are that you making things
harder on yourself than ought to be.</p>

<p>Maybe it is better structured as:</p>

<pre><code>$overlay/mygroup/etc/
</code></pre>

<p>but maybe it is better structured as:</p>

<pre><code>$overlay/all/etc/somefile._all
$overlay/all/etc/somefile._mygroup
</code></pre>

<p>The main message is &#8220;keep it simple&#8221;. Try not to use too many group
directories, because it makes things complicated.</p>

<h2>5.4 Do not manage the master node</h2>

<p>It is recommended that you do not manage the master node with synctool.
The reason is that it makes things more complicated when you choose to put
the configuration of your master node under control of synctool.</p>

<p>Why is this? It is mainly because synctool by default works on &#8216;all&#8217; nodes,
and for some reason it is unnatural when &#8216;all&#8217; includes the master node too.
Imagine calling <code>dsh reboot</code> to reboot all nodes, and pulling down the master
with you (in the middle of the process, so you may not even succeed at
rebooting all nodes).</p>

<p>It often means doing double work; the config files of the master node tend
to differ from the ones on your nodes. It is good practice though to label
the master node as <em>master</em>, and to simply ignore it:</p>

<pre><code>node n01 master
ignore_group master
</code></pre>

<p>It&#8217;s also OK to leave the master node out of the configuration altogether.
(Here, &#8216;master&#8217; is a group, not to be confused with the <code>master</code> keyword that
defines the master node. Are you still with me?)</p>

<p>If you still want to manage the master with synctool, do as you must. Just be
sure to call <code>dsh -X master reboot</code> when you want to reboot your cluster.</p>

<h2>5.5 Managing multiple clusters with one synctool</h2>

<p>It is really easy to manage just one cluster with one synctool. This means
that your repository will contain files that apply only to that cluster.
In reality, you may have only one management host for managing multiple
clusters, or you may have several subclusters in a single cluster.</p>

<p>Managing such a setup with synctool used to be hard &amp; hackish, but since
version 6 it is only a matter of using groups in the right way.</p>

<p>Add all clusters to the synctool repository as you would with adding more
nodes. Create a group for each (sub)cluster. For each clustergroup, add a
directory <code>overlay/cluster/</code>, so you can handle them independently whenever
you wish to. Your repository will look like this:</p>

<pre><code>$overlay/all/
$overlay/cluster1/
$overlay/cluster2/
$overlay/cluster3/
</code></pre>

<p>If you tend to reinstall systems a lot with different operating systems,
it may be a good idea to create per OS groups. This also helps when upgrading
to new OS releases.</p>

<pre><code>$overlay/wheezy/
$overlay/centos64/
$overlay/sles11sp2/
</code></pre>

<p>Note that files under these directories can still be marked <code>._all</code>, synctool
will select the correct file as long as you tag the node with the right group.</p>

<p>Decide for yourself what files should go under what directory, and what
layout works best for you.</p>

<h2>5.6 Use a tiered setup for large clusters</h2>

<p>If you have a large cluster consisting of hundreds or thousands (or maybe
more) nodes, you will run into a scaling issue at the master node.
synctool doesn&#8217;t care how many nodes you manage with it, but doing a
synctool run to a large number of nodes will take considerable time. You can
increase the <code>num_proc</code> parameter to have synctool do more work in parallel,
but this will put more load on your master node. To manage such a large
cluster with synctool, a different approach is needed.</p>

<p>The solution is to make a tiered setup. In such a setup, the master node syncs
to other master nodes (for example, the first node in a rack), which in turn
sync to subsets of nodes. Script it along these lines:</p>

<pre><code>#! /bin/bash

for rack in $RACKS
do
    # give rackmasters a full copy of the repos
    rsync -a --delete /opt/synctool/ ${rack}-n1:/opt/synctool/

    # run synctool on rackmaster
    dsh -n ${rack}-n1 --no-nodename \
      /opt/synctool/bin/synctool -g $rack "$@"
done &amp;
wait
</code></pre>

<p>So, the master node syncs to &#8216;rack masters&#8217;, and the rack masters in turn
run synctool on their subset of nodes. In the config, the nodes are
grouped by rack. The option <code>--no-nodename</code> is used with <code>dsh</code> to make the
output come out right.
You also still need to manage the rack masters &#8212; with synctool, from the
master node.</p>

<p>A slightly different solution is to make use of slave nodes; the master
syncs full copies only to slaves; next, the slaves manage the nodes.
This requires having multiple config files (eg, one per rack) and scripting
it so that it uses the correct config file for each rack.</p>

<pre><code>synctool -c slaves.conf "$@"
for rack in $RACKS
do
    dsh -n ${rack}-n1  --no-nodename \
      synctool -c confs/${rack}.conf "$@"
done
</code></pre>

<p>This tip is mentioned here mostly for completeness; I recommend running with
a setup like this only if you are truly experiencing problems due to the
scale of your cluster. There are security implications to consider when
giving nodes a full copy of the repository. It depends on your situation
whether it is acceptable to run like this.</p>

<h2>5.7 Manage hosts behind a gateway</h2>

<p>As synctool relies on SSH authentication you can easily manage hosts that are
not directly available. Imagine this setup:</p>

<pre><code>synctool-master-node
    |
Internet
    |
gateway.your.domain
    |
    + privatenode1
    + privatenode2
</code></pre>

<p>You need to set up your ssh connection as follows in <code>/root/.ssh/config</code>:</p>

<pre><code>Host *.intra.your.domain
    ProxyCommand ssh gateway.your.domain -W %h:22
</code></pre>

<p>Add your hosts in <code>synctool.conf</code>:</p>

<pre><code>node privatenode1 group1 group2 ipaddress:privatenode1.intra.your.domain
node privatenode2 group1 group2 ipaddress:privatenode2.intra.your.domain
</code></pre>

<p>Of course this requires also a proper DNS setup for your intra zone
at <code>gateway.your.domain</code></p>
<br /><br /><div class="line"> </div><br /> 
<h1>6. Thank you</h1>

<p>A big thanks goes out to all synctool users. You know who you are (!)
Special thanks go to those whom I&#8217;ve had e-mail conversations with about
synctool, and those at <a href="https://github.com/walterdejong/synctool">github</a> who have made good suggestions for
improving synctool.
And last but not least, very special thanks go to those who contributed to
synctool in one way or another. synctool would not be what it is today
without your contributions.</p>

<p>If you also want to contribute to synctool, drop me an e-mail. If you are a
programmer who likes to contribute to the development of synctool, please
fork the <a href="https://github.com/walterdejong/synctool">github project</a> and issue pull requests. If you don&#8217;t know how
<code>git</code> works, patches in <code>diff -u</code> format are always welcome too. However,
I highly recommend <code>git</code> and <a href="https://github.com/walterdejong/synctool">github</a>.</p>
<br /><br /><div class="line"> </div><br /> 
<div id="footer"> 
<div class="line"> </div><br />
If you really must, you can contact the author at
<a href="mailto:walter at heiho dot net">walter at heiho dot net</a>
</div>

</div>    <!-- end content -->
</div>    <!-- end page -->

</body>
</html>
